{% extends "accounts/boss/base.html" %}
{% block title %}CTG Admin - Clients{% endblock %}
{% load static %}
{% block content %}
    <div id="content-page" class="content-page">
        <div class="container-fluid">
            <!-- Header + Search -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>
                    <i class="bi bi-people-fill"></i> Client List
                </h4>
                <form method="get" class="d-flex">
                    <input type="text"
                           name="q"
                           class="form-control me-2"
                           placeholder="Search clients..."
                           value="{{ request.GET.q|default:'' }}">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> Search
                    </button>
                </form>
            </div>
            <div class="iq-card">
                <div class="iq-card-body">
                    {% if users %}
                        <div class="table-responsive">
                            <table id="user-list-table" class="table table-striped table-bordered mt-4">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Balance</th>
                                        <th>Contact</th>
                                        <th>Country</th>
                                        <th>Status</th>
                                        <th>Date Joined</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for client in users %}
                                        <tr class="client-row"
                                            style="cursor:pointer"
                                            data-username="{{ client.user.username }}"
                                            data-email="{{ client.user.email }}"
                                            data-balance="{{ client.account.main_balance }}"
                                            data-phone="{{ client.phone_number }}"
                                            data-country="{{ client.country.name }}"
                                            data-status="{{ client.Verification_status }}"
                                            data-date="{{ client.user.date_joined|date:'d M Y' }}"
                                            data-view-url="{% url 'boss:client_profile' client.id %}"
                                            data-delete-url="{% url 'boss:client_delete' client.id %}">
                                            <td>{{ client.user.username }}</td>
                                            <td>{{ client.user.email }}</td>
                                            <td>{{ client.account.main_balance }}</td>
                                            <td>{{ client.phone_number }}</td>
                                            <td>{{ client.country.name }}</td>
                                            <td>
                                                {% if client.Verification_status == "Unverified" %}
                                                    <span class="badge bg-danger">{{ client.Verification_status }}</span>
                                                {% elif client.Verification_status == "Verified" %}
                                                    <span class="badge bg-primary">{{ client.Verification_status }}</span>
                                                {% elif client.Verification_status == "Under Review" %}
                                                    <span class="badge bg-warning text-dark">{{ client.Verification_status }}</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ client.user.date_joined|date:"d M Y" }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination -->
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center mt-3">
                                {% if users.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link"
                                           href="?q={{ request.GET.q|urlencode }}&page={{ users.previous_page_number }}">Previous</a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">Previous</span>
                                    </li>
                                {% endif %}
                                {% for i in users.paginator.page_range %}
                                    {% if users.number == i %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ i }}</span>
                                        </li>
                                    {% else %}
                                        <li class="page-item">
                                            <a class="page-link"
                                               href="?q={{ request.GET.q|urlencode }}&page={{ i }}">{{ i }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                                {% if users.has_next %}
                                    <li class="page-item">
                                        <a class="page-link"
                                           href="?q={{ request.GET.q|urlencode }}&page={{ users.next_page_number }}">Next</a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">Next</span>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    {% else %}
                        <div class="text-center my-5">
                            <i class="bi bi-emoji-frown display-1 text-muted"></i>
                            <p class="mt-3 text-muted fs-5">No clients found</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <!-- Client Details Modal -->
    <div class="modal fade" id="clientModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-person-lines-fill"></i> Client Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="clientModalBody"></div>
                <div class="modal-footer">
                    <a href="#" class="btn btn-primary" id="viewProfileBtn"><i class="bi bi-eye"></i> View Profile</a>
                    <button type="button" class="btn btn-danger" id="deleteClientBtn">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle-fill"></i> Confirm Delete
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">Are you sure you want to delete this client?</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <a href="#" class="btn btn-danger" id="confirmDeleteBtn">Delete</a>
                </div>
            </div>
        </div>
    </div>
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
document.addEventListener("DOMContentLoaded", function () {
  const clientModal = new bootstrap.Modal(document.getElementById("clientModal"));
  const deleteModal = new bootstrap.Modal(document.getElementById("deleteConfirmModal"));

  const modalBody = document.getElementById("clientModalBody");
  const viewProfileBtn = document.getElementById("viewProfileBtn");
  const deleteClientBtn = document.getElementById("deleteClientBtn");
  const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");

  let deleteUrl = "#";

  document.querySelectorAll(".client-row").forEach(row => {
    row.addEventListener("click", () => {
      modalBody.innerHTML = `
        <p><strong>Username:</strong> ${row.dataset.username}</p>
        <p><strong>Email:</strong> ${row.dataset.email}</p>
        <p><strong>Balance:</strong> ${row.dataset.balance}</p>
        <p><strong>Contact:</strong> ${row.dataset.phone}</p>
        <p><strong>Country:</strong> ${row.dataset.country}</p>
        <p><strong>Status:</strong> ${row.dataset.status}</p>
        <p><strong>Date Joined:</strong> ${row.dataset.date}</p>
      `;
      viewProfileBtn.href = row.dataset.viewUrl;
      deleteUrl = row.dataset.deleteUrl;
      clientModal.show();
    });
  });

  deleteClientBtn.addEventListener("click", () => {
    clientModal.hide();
    deleteModal.show();
  });

  confirmDeleteBtn.addEventListener("click", () => {
    window.location.href = deleteUrl;
  });
});
    </script>
{% endblock %}
