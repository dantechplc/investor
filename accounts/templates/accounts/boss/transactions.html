{% extends "accounts/boss/base.html" %}
{% block title %}CTG ADMIN  - Transactions{% endblock %}
{% load static %}
{% block content %}
    <div id="content-page" class="content-page">
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-12">
                    <div class="iq-card">
                        <div class="iq-card-header d-flex justify-content-between align-items-center">
                            <div class="iq-header-title">
                                <h4 class="card-title">All Transactions</h4>
                            </div>
                        </div>
                        <div class="iq-card-body">
                            <!-- Server-side Search Form -->
                            <form method="get" class="mb-3">
                                <div class="input-group">
                                    <input type="text"
                                           name="q"
                                           class="form-control"
                                           placeholder="Search transactions..."
                                           value="{{ q }}">
                                    <button class="btn btn-primary" type="submit">
                                        <i class="bi bi-search"></i> Search
                                    </button>
                                </div>
                            </form>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Type</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for tx in transactions %}
                                            <tr class="transaction-row"
                                                style="cursor: pointer"
                                                data-id="{{ tx.id }}"
                                                data-user="{{ tx.user }}"
                                                data-type="{{ tx.transaction_type }}"
                                                data-amount="{{ tx.amount }}"
                                                data-status="{{ tx.status }}"
                                                data-transactionid="{{ tx.trx_id }}"
                                                data-date="{{ tx.date|date:'d M Y H:i' }}"
                                                data-receipt="{% if tx.receipt_upload %}{{ tx.receipt_upload.url }}{% else %}{% endif %}">
                                                <td>{{ tx.user }}</td>
                                                <td>{{ tx.transaction_type }}</td>
                                                <td>{{ tx.amount }}</td>
                                                <td>
                                                    {% if tx.status == "pending" %}
                                                        <span class="badge bg-warning text-dark">Pending</span>
                                                    {% elif tx.status == "Successful" %}
                                                        <span class="badge bg-success">Successful</span>
                                                    {% elif tx.status == "failed" %}
                                                        <span class="badge bg-danger">Failed</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ tx.date|date:"d M Y H:i" }}</td>
                                            </tr>
                                        {% empty %}
                                            <tr>
                                                <td colspan="5" class="text-center">No transactions found</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <!-- Pagination -->
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center">
                                    {% if transactions.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link"
                                               href="?q={{ q }}&page={{ transactions.previous_page_number }}">Previous</a>
                                        </li>
                                    {% endif %}
                                    {% for num in transactions.paginator.page_range %}
                                        <li class="page-item {% if transactions.number == num %}active{% endif %}">
                                            <a class="page-link" href="?q={{ q }}&page={{ num }}">{{ num }}</a>
                                        </li>
                                    {% endfor %}
                                    {% if transactions.has_next %}
                                        <li class="page-item">
                                            <a class="page-link"
                                               href="?q={{ q }}&page={{ transactions.next_page_number }}">Next</a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Transaction Modal -->
    <div class="modal fade" id="transactionModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form method="post" id="transactionForm">
                    {% csrf_token %}
                    <input type="hidden" name="transaction_id" id="transactionIdField">
                    <input type="hidden" name="action" id="actionField">
                    <div class="modal-header">
                        <h5 class="modal-title">Transaction Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>
                            <strong>User:</strong> <span id="modalUser"></span>
                        </p>
                        <p>
                            <strong>Type:</strong> <span id="modalType"></span>
                        </p>
                        <p>
                            <strong>Amount:</strong> <span id="modalAmount"></span>
                        </p>
                        <p>
                            <strong>Status:</strong> <span id="modalStatus"></span>
                        </p>
                        <p>
                            <strong>Transaction ID:</strong> <span id="modaltransactionid"></span>
                        </p>
                        <p>
                            <strong>Date:</strong> <span id="modalDate"></span>
                        </p>
                        <div id="receiptPreview" class="mt-3"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-success d-none" id="confirmBtn">Confirm</button>
                        <button type="button" class="btn btn-warning d-none" id="declineBtn">Decline</button>
                        <button type="button" class="btn btn-danger" id="deleteBtn">Delete</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
document.addEventListener("DOMContentLoaded", function () {
  const modal = new bootstrap.Modal(document.getElementById("transactionModal"));
  const form = document.getElementById("transactionForm");

  const idField = document.getElementById("transactionIdField");
  const actionField = document.getElementById("actionField");

  const confirmBtn = document.getElementById("confirmBtn");
  const declineBtn = document.getElementById("declineBtn");
  const deleteBtn = document.getElementById("deleteBtn");

  document.querySelectorAll(".transaction-row").forEach(row => {
    row.addEventListener("click", () => {
      document.getElementById("modalUser").textContent = row.dataset.user;
      document.getElementById("modalType").textContent = row.dataset.type;
      document.getElementById("modalAmount").textContent = row.dataset.amount;
      document.getElementById("modalStatus").textContent = row.dataset.status;
      document.getElementById("modaltransactionid").textContent = row.dataset.transactionid;
      document.getElementById("modalDate").textContent = row.dataset.date;

      idField.value = row.dataset.id;

      const receipt = row.dataset.receipt;
      const receiptDiv = document.getElementById("receiptPreview");
      receiptDiv.innerHTML = "";
      if (receipt) {
        if (receipt.toLowerCase().endsWith(".pdf")) {
          receiptDiv.innerHTML = `<p><strong>Receipt:</strong> <a href="${receipt}" target="_blank">View PDF</a></p>`;
        } else {
          receiptDiv.innerHTML = `<p><strong>Receipt:</strong></p><img src="${receipt}" alt="Receipt" class="img-fluid rounded border">`;
        }
      }

      if (row.dataset.status === "pending") {
        confirmBtn.classList.remove("d-none");
        declineBtn.classList.remove("d-none");
      } else {
        confirmBtn.classList.add("d-none");
        declineBtn.classList.add("d-none");
      }

      modal.show();
    });
  });

  function handleAction(action, text, color) {
    Swal.fire({
      title: "Are you sure?",
      text: text,
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: color,
      cancelButtonColor: "#6c757d",
      confirmButtonText: "Yes, proceed"
    }).then((result) => {
      if (result.isConfirmed) {
        actionField.value = action;
        form.submit();
      }
    });
  }

  confirmBtn.addEventListener("click", () => {
    handleAction("confirm", "This transaction will be confirmed.", "#198754");
  });

  declineBtn.addEventListener("click", () => {
    handleAction("decline", "This transaction will be declined.", "#ffc107");
  });

  deleteBtn.addEventListener("click", () => {
    handleAction("delete", "This transaction will be permanently deleted!", "#dc3545");
  });
});
    </script>
{% endblock %}
