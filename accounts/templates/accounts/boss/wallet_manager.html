{% extends "accounts/boss/base.html" %}
{% block title %}Admin | Wallet Manager{% endblock %}
{% load static %}
{% block content %}
    <div id="content-page" class="content-page">
        <div class="container-fluid">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4>
                    <i class="bi bi-wallet2"></i> Wallets
                </h4>
                <button class="btn btn-success"
                        data-bs-toggle="modal"
                        data-bs-target="#addWalletModal">
                    <i class="bi bi-plus-lg"></i> Add Wallet
                </button>
            </div>
            {% if wallets %}
                <div class="list-group">
                    {% for wallet in wallets %}
                        <a href="#"
                           class="list-group-item list-group-item-action wallet-item d-flex align-items-center"
                           data-id="{{ wallet.id }}"
                           data-name="{{ wallet.name }}"
                           data-address="{{ wallet.wallet_address }}"
                           data-qr="{% if wallet.wallet_qr_code %}{{ wallet.wallet_qr_code.url }}{% endif %}"
                           data-bs-toggle="modal"
                           data-bs-target="#walletModal">
                            <img src="{% if wallet.wallet_qr_code %}{{ wallet.wallet_qr_code.url }}{% else %}{% static 'icons/qr-placeholder.png' %}{% endif %}"
                                 alt="QR"
                                 class="me-3"
                                 style="width:40px;
                                        height:40px;
                                        border-radius:5px;
                                        object-fit:cover">
                            <div class="flex-grow-1">
                                <strong>{{ wallet.name }}</strong>
                                <div class="text-muted small">{{ wallet.wallet_address }}</div>
                            </div>
                            <i class="bi bi-chevron-right ms-2 text-muted"></i>
                        </a>
                        <!-- Hidden delete form for this wallet -->
                        <form id="deleteForm{{ wallet.id }}"
                              method="post"
                              action="{% url 'boss:wallet_delete' wallet.id %}"
                              style="display:none">
                            {% csrf_token %}
                        </form>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-5">
                    <img src="{% static 'illustrations/empty-wallet.svg' %}"
                         alt="No Wallets"
                         style="max-width:200px">
                    <h5 class="mt-3">No wallets found</h5>
                    <p class="text-muted">
                        Click <strong>+ Add Wallet</strong> to create one.
                    </p>
                </div>
            {% endif %}
        </div>
    </div>
    <!-- Add Wallet Modal -->
    <div class="modal fade"
         id="addWalletModal"
         tabindex="-1"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-plus-lg"></i> Add New Wallet
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">{{ form.as_p }}</div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-lg"></i> Save
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Edit/Delete Wallet Modal -->
    <div class="modal fade" id="walletModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" id="editWalletForm">
                    {% csrf_token %}
                    <input type="hidden" name="wallet_id" id="editWalletId">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-pencil-square"></i> Wallet Details
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label>Name</label>
                            <input type="text" name="name" id="editWalletName" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label>Wallet Address</label>
                            <input type="text"
                                   name="wallet_address"
                                   id="editWalletAddress"
                                   class="form-control">
                        </div>
                        <div class="mb-3 text-center">
                            <label>Wallet QR Code</label>
                            <div>
                                <img id="editWalletQR"
                                     src=""
                                     alt="QR Code"
                                     style="max-width:200px;
                                            border:1px solid #ddd;
                                            border-radius:8px">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Save
                        </button>
                        <button type="button" class="btn btn-danger" id="deleteWalletBtn">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
document.addEventListener("DOMContentLoaded", function () {
    const editId = document.getElementById("editWalletId");
    const editName = document.getElementById("editWalletName");
    const editAddress = document.getElementById("editWalletAddress");
    const editQR = document.getElementById("editWalletQR");
    const deleteBtn = document.getElementById("deleteWalletBtn");

    let currentWalletId = null;

    // Populate edit modal
    document.querySelectorAll(".wallet-item").forEach(item => {
        item.addEventListener("click", () => {
            currentWalletId = item.dataset.id;
            editId.value = currentWalletId;
            editName.value = item.dataset.name;
            editAddress.value = item.dataset.address;
            editQR.src = item.dataset.qr || "{% static 'icons/qr-placeholder.png' %}";
        });
    });

    // Delete with hidden form
    deleteBtn.addEventListener("click", () => {
        Swal.fire({
            title: "Are you sure?",
            text: "This wallet will be permanently deleted!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#3085d6",
            confirmButtonText: "Yes, delete it!"
        }).then((result) => {
            if (result.isConfirmed && currentWalletId) {
                document.getElementById("deleteForm" + currentWalletId).submit();
            }
        });
    });
});
    </script>
{% endblock %}
